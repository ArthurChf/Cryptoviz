CREATE FUNCTION formatNumber AS(x) -> if(toFloat64(x) <= 0.1, if(toFloat64(x) = 0, '0', x), replaceAll(toString(toDecimal64(x, 2)), '.00', ''));
CREATE FUNCTION dollar AS(s) -> concat('$', s);
CREATE FUNCTION imageUrl AS(s) -> concat('currencies/', lower(s), '.webp');

SELECT imageUrl(c.coin) AS image,
       c.name AS name,
       c.coin AS symbol,
       toFloat64(formatNumber(c.priceChange)) AS priceChangeRate,
       dollar(formatNumber(c.lastPrice)) AS price,
       dollar(formatNumber(c.totalTradedBaseAssetVolume)) AS volume,
       dollar(formatNumber(c.highPrice)) AS priceHigh,
       dollar(formatNumber(c.lowPrice)) AS priceLow,
       c.totalNumberOfTrades AS transactions
FROM crypto c
INNER JOIN (SELECT coin, max(createdAt) AS lastCreatedAt FROM crypto GROUP BY symbol, coin) lastDates
ON c.createdAt = lastDates.lastCreatedAt AND c.coin = lastDates.coin
ORDER BY toFloat64(c.lastPrice) DESC;